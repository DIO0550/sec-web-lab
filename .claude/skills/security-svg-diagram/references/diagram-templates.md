# Diagram Templates

SVG図のレイアウトテンプレート定義。攻撃の内容自体はClaudeの知識を使い、ここでは**どんな図にするか**のパターンを定義する。

## 目次

1. [テンプレート型の一覧](#テンプレート型の一覧)
2. [攻撃タイプ → テンプレート型のマッピング](#マッピング)
3. [Flow型テンプレート](#flow型テンプレート)
4. [中間割込型テンプレート](#中間割込型テンプレート)
5. [集中型テンプレート](#集中型テンプレート)
6. [階層型テンプレート](#階層型テンプレート)
7. [Timeline型テンプレート](#timeline型テンプレート)
8. [対策図の共通パターン](#対策図の共通パターン)

---

## テンプレート型の一覧

| 型 | アクター配置 | 矢印の特徴 | 適した攻撃 |
|----|------------|-----------|-----------|
| **Flow型** | 左→中→右の3列 | 上カーブ(①)→直線(②③)→縦(④)→下カーブ(⑤) | 3者間を経由する攻撃 |
| **中間割込型** | 左＝右、中央に攻撃者割込 | 被害者↔攻撃者↔サーバーの双方向 | 通信傍受・改ざん系 |
| **集中型** | 左1 → 中央複数 → 右1 | 多対一の扇状矢印 | 大量トラフィック系 |
| **階層型** | 上→中→下の縦3段 | 上から下へ層を掘り下げる | アプリ層→DB層への侵入系 |
| **Timeline型** | 左→右への時系列 | 左から右へ段階的進行 | 多段階の攻撃プロセス |

---

## マッピング

| 攻撃タイプ | テンプレート型 | アクター構成 |
|-----------|-------------|-------------|
| XSS (Reflected/Stored) | Flow型 | 攻撃者, Webサーバー, 被害者 |
| XSS (DOM-based) | Flow型 (2アクター変形) | 攻撃者, 被害者ブラウザ |
| CSRF | Flow型 | 攻撃者(罠サイト), 被害者, 正規サーバー |
| Phishing | Flow型 | 攻撃者, 偽サイト/メール, 被害者 |
| MITM | 中間割込型 | 被害者, 攻撃者(中間), サーバー |
| DNS Spoofing | 中間割込型 | 被害者, DNS(汚染), 攻撃者サーバー |
| ARP Spoofing | 中間割込型 | 被害者, 攻撃者(LAN), ゲートウェイ |
| DDoS | 集中型 | 攻撃者, ボットネット群, ターゲット |
| SQL Injection | 階層型 | 攻撃者, Webサーバー, データベース |
| Buffer Overflow | 階層型 | 攻撃者, アプリケーション, メモリ |
| Ransomware | Timeline型 | 攻撃者, 被害者PC, ファイル |
| Supply Chain | Timeline型 | 攻撃者, サプライヤー, 利用者 |
| Session Hijacking | Flow型 | 攻撃者, ネットワーク, 被害者セッション |
| Clickjacking | Flow型 | 攻撃者(罠サイト), 被害者, 正規サイト |
| Credential Stuffing | Flow型 | 攻撃者, 流出リスト, ターゲットサイト |

---

## Flow型テンプレート

最も汎用的なパターン。プロトタイプSVG（`assets/xss-reflected-attack.svg`）がこの型の実装例。

### アクター配置

```
viewBox: 0 0 1100 750

     ┌──────┐         ┌──────┐         ┌──────┐
     │左アクター│         │中アクター│         │右アクター│
     │ x=115 │         │ x=380 │         │ x=645 │
     │ y=250 │         │ y=250 │         │ y=250 │
     └──────┘         └──────┘         └──────┘
```

- 3アクター: x = 115, 380, 645 (等間隔265px)
- 全アクター共通: y = 250, 幅112, 高さ125

### 矢印ルーティング

```
① 左→右 上カーブ: Q(cx, 115) で頂点 — 番号バッジはカーブ頂点
② 右→中 直線: Y=240 — バッジは矢印の上 (Y=218)
③ 中→右 直線: Y=282 — バッジは矢印の下 (Y=304)
④ 右→下 縦矢印 — バッジは矢印の横 (右24px)
⑤ 下→左 下カーブ: C制御点Y=640+ — 全ボックスの下を通過
```

重要: ⑤の曲線は脆弱性ボックスやコード例の**下**を通すこと。制御点Yは最下部のボックス要素Y + 60px以上。

### サイドバー・下部

```
右サイドバー (x=775, w=305):
  "攻撃ステップ詳細" — 各ステップのタイトル+説明2行
  配下に凡例パネル

下部セクション:
  区切り線
  "🔥 使用される攻撃テクニック" 見出し
  カード3枚を等間隔配置 (x中心: 165, 465, 765)
```

### 2アクター変形（DOM-based XSS等）

サーバーが関与しないパターン。中央アクターを省略し、左右の間隔を広げる。

```
     ┌──────┐                           ┌──────┐
     │攻撃者  │                           │被害者  │
     │ x=200 │                           │ x=600 │
     └──────┘                           └──────┘
```

ブラウザボックスを被害者の下に配置し、DOM操作の流れを縦矢印で表現。

---

## 中間割込型テンプレート

攻撃者が通信の中間に位置するパターン（MITM、DNS Spoofing等）。

### アクター配置

```
viewBox: 0 0 1100 750

     ┌──────┐         ┌──────┐         ┌──────┐
     │被害者  │         │攻撃者  │         │サーバー │
     │ x=115 │         │ x=380 │         │ x=645 │
     │ y=250 │         │ y=250 │         │ y=250 │
     └──────┘         └──────┘         └──────┘
```

特徴: **攻撃者が中央**。被害者とサーバーが両端。

### 矢印ルーティング

```
正規通信（上段・薄い破線）:
  被害者 ──→ サーバー (上カーブ、グレー破線、「本来の通信」ラベル)

実際の通信（中段・2段構成）:
  ① 被害者 → 攻撃者 (直線、紫) — 被害者は気づかず送信
  ② 攻撃者が傍受・閲覧 (攻撃者内に虫眼鏡アイコン)
  ③ 攻撃者 → サーバー (直線、赤破線) — 改ざんして転送
  ④ サーバー → 攻撃者 (直線、青) — レスポンスも攻撃者経由
  ⑤ 攻撃者 → 被害者 (直線、赤破線) — 改ざんレスポンス転送
```

### 補助要素

- 攻撃者カードの下に「傍受内容」ボックス（認証情報、通信内容等）
- 被害者←→サーバー間に「暗号化なし/偽証明書」の警告ラベル

---

## 集中型テンプレート

多数の送信元から1つのターゲットへ集中するパターン（DDoS等）。

### アクター配置

```
viewBox: 0 0 1100 700

  ┌──────┐      ┌──┐ ┌──┐ ┌──┐
  │攻撃者  │  →   │Bot│ │Bot│ │Bot│   →→→   ┌──────┐
  │ x=100 │      │  │ │  │ │  │         │ターゲット│
  └──────┘      └──┘ └──┘ └──┘         │ x=800 │
                ┌──┐ ┌──┐              └──────┘
                │Bot│ │Bot│
                └──┘ └──┘
                x=350-550, y=180-380
```

特徴:
- 中央にボットネット群（小サイズアクター、50x50px程度、5-7個を散らす）
- 攻撃者→ボット群: 1本の矢印から扇状に分岐
- ボット群→ターゲット: 複数の赤矢印がターゲットに集中
- ターゲットに「過負荷」エフェクト（赤いパルスリング、⚠アイコン）

### ボットアイコン（小サイズ）

```xml
<g transform="translate(X, Y)">
  <rect x="-25" y="-25" width="50" height="50" rx="8" fill="#1e1b2e" stroke="#ef4444" stroke-width="1" opacity="0.7"/>
  <rect x="-12" y="-12" width="24" height="16" rx="2" fill="none" stroke="#ef4444" stroke-width="1"/>
  <circle cx="-4" cy="-4" r="1.5" fill="#ef4444"/>
  <circle cx="4" cy="-4" r="1.5" fill="#ef4444"/>
  <text x="0" y="18" text-anchor="middle" fill="#fca5a5" font-size="7">Bot</text>
</g>
```

---

## 階層型テンプレート

上から下へレイヤーを掘り下げるパターン（SQL Injection等）。

### アクター配置

```
viewBox: 0 0 1100 800

           ┌──────┐
           │攻撃者  │  ← 入力の送信元
           │ x=400 │
           │ y=120 │
           └──────┘
               │
               ▼
           ┌──────┐
           │Webサーバー│  ← クエリ構築層
           │ x=400 │
           │ y=320 │
           └──────┘
               │
               ▼
           ┌──────┐
           │ DB    │  ← データ層
           │ x=400 │
           │ y=520 │
           └──────┘
```

特徴:
- アクターを縦に配置（x共通、y間隔200px）
- 矢印は主に縦方向
- 各層の間に「変換過程」ボックス（入力→SQL文構築→実行結果）
- サイドバーを右に、コード例を左に配置

### 矢印ルーティング

```
① 攻撃者→サーバー (縦矢印、赤) — 悪意ある入力
② サーバー内処理 (サーバーカード内にコード表示) — SQL文構築
③ サーバー→DB (縦矢印、赤破線) — 改ざんされたクエリ
④ DB→サーバー (やや右にオフセットした縦矢印、青) — 不正なデータ返却
⑤ サーバー→攻撃者 (やや右にオフセットした縦矢印、赤) — データ窃取
```

左右にオフセット（+30px）して上り下りの矢印を区別する。

---

## Timeline型テンプレート

時系列に沿った段階的攻撃プロセス（Ransomware、Supply Chain等）。

### レイアウト

```
viewBox: 0 0 1200 650

  Phase 1        Phase 2        Phase 3        Phase 4        Phase 5
  ┌─────┐   →   ┌─────┐   →   ┌─────┐   →   ┌─────┐   →   ┌─────┐
  │ 侵入 │       │ 展開 │       │ 実行 │       │ 影響 │       │ 結果 │
  │x=110│       │x=330│       │x=550│       │x=770│       │x=990│
  │y=280│       │y=280│       │y=280│       │y=280│       │y=280│
  └─────┘       └─────┘       └─────┘       └─────┘       └─────┘
```

特徴:
- viewBoxが横長（1200幅）
- 各フェーズを小さめのカード（90x110px）で横に並べる
- フェーズ間を→矢印で接続
- 各カード上部にフェーズ番号とアイコン
- カード下に短い説明テキスト
- タイムライン軸（Y=350付近に横線）にフェーズラベル
- サイドバーは右ではなく**下部にステップ詳細**を横並びで配置

### フェーズカード

```xml
<g transform="translate(X, 280)" filter="url(#shadow)">
  <rect x="-45" y="-55" width="90" height="110" rx="10" fill="#1e1b2e" stroke="{phaseColor}" stroke-width="1.5"/>
  <!-- フェーズ番号 -->
  <circle cx="0" cy="-38" r="12" fill="{phaseColor}"/>
  <text x="0" y="-34" text-anchor="middle" fill="#fff" font-size="11" font-weight="700">{N}</text>
  <!-- アイコン (中央) -->
  <!-- ... -->
  <!-- ラベル -->
  <text x="0" y="32" text-anchor="middle" fill="#f8fafc" font-size="10" font-weight="600">{フェーズ名}</text>
  <text x="0" y="46" text-anchor="middle" fill="#94a3b8" font-size="8">{短い説明}</text>
</g>
```

---

## 対策図の共通パターン

全テンプレート型に共通する対策図の表現ルール。

### 攻撃者の表現

- 攻撃者アクターを `opacity="0.45"` で薄く表示（無力化された印象）
- 攻撃矢印も `opacity="0.15-0.3"` で薄く

### 防御ポイントの表現

攻撃が遮断される箇所にブロックマーク（✗）を配置:

```xml
<!-- 緑の丸に×マーク -->
<g transform="translate({X}, {Y})">
  <circle r="16" fill="#052e16" stroke="#22c55e" stroke-width="2" filter="url(#glowGreen)"/>
  <line x1="-6" y1="-6" x2="6" y2="6" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="6" y1="-6" x2="-6" y2="6" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round"/>
</g>
```

**重要: ブロックマークの配置ルール**
- ブロックマーク（✗、半径16px）は近接する防御カードや壁カードと重ならないこと
- 防御壁カードの右端/下端から最低10pxのマージンを確保
- 矢印ラインの途中かつカードの外側に配置する
- バウンディングボックスを計算して重なりチェックを行うこと（`translate(x,y)` + `circle r=16` → 占有領域は `[x-16, x+16] × [y-16, y+16]`）

### 防御カードの配置

- アクター間の経路上（WAFなど）または、アクターの下部（CSP、HttpOnlyなど）に配置
- 全カード: 背景 `#052e16`、ボーダー `#22c55e`
- アイコン + 名前 + 説明 + コード例の構成

### サイドバー

- 攻撃図の「攻撃ステップ詳細」を「防御レイヤー一覧」に差し替え
- ボーダー色を `#22c55e` に変更
- 末尾に「🔒 多層防御 (Defense in Depth)」注記

### 保護されたアクター

サーバーと被害者のカード枠を `stroke="#22c55e"` に変更し、右上に盾バッジを追加。

### 凡例

```
遮断された攻撃 (薄い赤破線)  |  ブロックポイント (緑✗)  |  防御機構 (緑カード)
```
