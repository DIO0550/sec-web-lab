<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 920 700" font-family="'Segoe UI', 'Helvetica Neue', Arial, sans-serif">
  <defs>
    <!-- 背景グラデーション -->
    <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#0f172a"/>
      <stop offset="100%" stop-color="#1e293b"/>
    </linearGradient>
    <!-- 攻撃者カラー -->
    <linearGradient id="attackerGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#dc2626"/>
      <stop offset="100%" stop-color="#991b1b"/>
    </linearGradient>
    <!-- 被害者カラー -->
    <linearGradient id="victimGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#f59e0b"/>
      <stop offset="100%" stop-color="#d97706"/>
    </linearGradient>
    <!-- 攻撃者サイトカラー -->
    <linearGradient id="evilSiteGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#7c3aed"/>
      <stop offset="100%" stop-color="#6d28d9"/>
    </linearGradient>
    <!-- 対象サーバーカラー -->
    <linearGradient id="serverGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#2563eb"/>
      <stop offset="100%" stop-color="#1d4ed8"/>
    </linearGradient>
    <!-- 安全カラー -->
    <linearGradient id="safeGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#059669"/>
      <stop offset="100%" stop-color="#047857"/>
    </linearGradient>
    <!-- 矢印マーカー -->
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f87171"/>
    </marker>
    <marker id="arrowYellow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#a78bfa"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#60a5fa"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34d399"/>
    </marker>
    <!-- ドロップシャドウ -->
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="110%">
      <feDropShadow dx="2" dy="3" stdDeviation="3" flood-opacity="0.4"/>
    </filter>
  </defs>

  <!-- 背景 -->
  <rect width="920" height="700" fill="url(#bg)" rx="12"/>

  <!-- タイトル -->
  <text x="460" y="40" text-anchor="middle" fill="#f1f5f9" font-size="22" font-weight="bold">CSRF 攻撃フロー</text>
  <text x="460" y="62" text-anchor="middle" fill="#94a3b8" font-size="13">Cross-Site Request Forgery — 被害者のセッションを悪用した不正リクエスト</text>

  <!-- ===== アクター ===== -->

  <!-- 攻撃者 -->
  <g filter="url(#shadow)">
    <rect x="40" y="95" width="170" height="70" rx="10" fill="url(#attackerGrad)" stroke="#f87171" stroke-width="1.5"/>
    <text x="125" y="125" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">&#x1F9D1;&#x200D;&#x1F4BB; 攻撃者</text>
    <text x="125" y="147" text-anchor="middle" fill="#fca5a5" font-size="11">罠サイトを用意</text>
  </g>

  <!-- 被害者 (ブラウザ) -->
  <g filter="url(#shadow)">
    <rect x="375" y="95" width="170" height="70" rx="10" fill="url(#victimGrad)" stroke="#fbbf24" stroke-width="1.5"/>
    <text x="460" y="125" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">&#x1F464; 被害者</text>
    <text x="460" y="147" text-anchor="middle" fill="#fef3c7" font-size="11">ログイン済みブラウザ</text>
  </g>

  <!-- 対象サーバー -->
  <g filter="url(#shadow)">
    <rect x="710" y="95" width="170" height="70" rx="10" fill="url(#serverGrad)" stroke="#60a5fa" stroke-width="1.5"/>
    <text x="795" y="125" text-anchor="middle" fill="#fff" font-size="14" font-weight="bold">&#x1F5A5;&#xFE0F; 対象サーバー</text>
    <text x="795" y="147" text-anchor="middle" fill="#93c5fd" font-size="11">example.com</text>
  </g>

  <!-- ===== 前提: 被害者はログイン済み ===== -->
  <g>
    <rect x="375" y="180" width="310" height="30" rx="6" fill="#1e1b2e" stroke="#fbbf24" stroke-width="1" stroke-dasharray="4 2"/>
    <text x="385" y="200" fill="#fbbf24" font-size="11">&#x1F36A; 前提: 被害者は対象サーバーにログイン済み (セッションCookie保持)</text>
  </g>

  <!-- ===== ステップ 1: 攻撃者 → 被害者 (罠リンク送信) ===== -->
  <line x1="210" y1="240" x2="370" y2="240" stroke="#f87171" stroke-width="2" marker-end="url(#arrowRed)"/>
  <g>
    <rect x="30" y="225" width="180" height="60" rx="8" fill="#1e1b2e" stroke="#f87171" stroke-width="1" stroke-dasharray="4 2"/>
    <text x="40" y="243" fill="#fbbf24" font-size="11" font-weight="bold">&#x2460; 罠リンクを送信</text>
    <text x="40" y="261" fill="#fca5a5" font-size="10" font-family="monospace">"面白い記事です！"</text>
    <text x="40" y="275" fill="#fca5a5" font-size="10" font-family="monospace">→ evil.com/trap.html</text>
  </g>

  <!-- ===== ステップ 2: 被害者が罠サイトを開く ===== -->
  <g>
    <rect x="375" y="300" width="260" height="78" rx="8" fill="#1e1b2e" stroke="#a78bfa" stroke-width="1" stroke-dasharray="4 2"/>
    <text x="385" y="318" fill="#fbbf24" font-size="11" font-weight="bold">&#x2461; 被害者が罠ページを開く</text>
    <text x="385" y="338" fill="#c4b5fd" font-size="10" font-family="monospace">&lt;form action="http://example</text>
    <text x="385" y="354" fill="#c4b5fd" font-size="10" font-family="monospace">  .com/api/change-password"</text>
    <text x="385" y="370" fill="#c4b5fd" font-size="10" font-family="monospace">  method="POST"&gt; ...</text>
  </g>

  <!-- ===== ステップ 3: ブラウザが自動送信 ===== -->
  <line x1="635" y1="350" x2="710" y2="350" stroke="#a78bfa" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <g>
    <rect x="640" y="300" width="245" height="78" rx="8" fill="#1e1b2e" stroke="#a78bfa" stroke-width="1" stroke-dasharray="4 2"/>
    <text x="650" y="318" fill="#fbbf24" font-size="11" font-weight="bold">&#x2462; ブラウザが自動でPOST送信</text>
    <text x="650" y="338" fill="#c4b5fd" font-size="10" font-family="monospace">POST /api/change-password</text>
    <text x="650" y="354" fill="#fca5a5" font-size="10" font-family="monospace">Cookie: session=abc123</text>
    <text x="650" y="370" fill="#c4b5fd" font-size="10" font-family="monospace">new_password=hacked</text>
  </g>

  <!-- ===== ポイント: Cookieが自動付与される ===== -->
  <g>
    <rect x="490" y="395" width="395" height="30" rx="6" fill="#450a0a" stroke="#f87171" stroke-width="1"/>
    <text x="500" y="415" fill="#f87171" font-size="11" font-weight="bold">&#x26A0;&#xFE0F; ブラウザがCookieを自動的に付与 → サーバーは正規リクエストと区別できない</text>
  </g>

  <!-- ===== ステップ 4: サーバーが処理 ===== -->
  <line x1="710" y1="445" x2="550" y2="445" stroke="#60a5fa" stroke-width="2" marker-end="url(#arrowBlue)"/>
  <g>
    <rect x="640" y="430" width="245" height="50" rx="8" fill="#1e1b2e" stroke="#60a5fa" stroke-width="1" stroke-dasharray="4 2"/>
    <text x="650" y="448" fill="#fbbf24" font-size="11" font-weight="bold">&#x2463; サーバーが正規リクエストとして処理</text>
    <text x="650" y="468" fill="#93c5fd" font-size="10">パスワードが攻撃者の指定値に変更される</text>
  </g>

  <!-- ===== 被害者の結果 ===== -->
  <g>
    <rect x="375" y="435" width="170" height="50" rx="8" fill="#450a0a" stroke="#f87171" stroke-width="1.5"/>
    <text x="460" y="457" text-anchor="middle" fill="#f87171" font-size="13" font-weight="bold">&#x26A0;&#xFE0F; パスワード変更</text>
    <text x="460" y="475" text-anchor="middle" fill="#fca5a5" font-size="11">被害者は気づかない</text>
  </g>

  <!-- ===== 下部: 原因と対策 ===== -->
  <line x1="40" y1="520" x2="880" y2="520" stroke="#334155" stroke-width="1"/>

  <text x="460" y="545" text-anchor="middle" fill="#94a3b8" font-size="14" font-weight="bold">対策: CSRFトークンによる検証</text>

  <!-- 脆弱なコード -->
  <g>
    <rect x="40" y="560" width="410" height="120" rx="8" fill="#2d1517" stroke="#f87171" stroke-width="1"/>
    <text x="55" y="582" fill="#f87171" font-size="12" font-weight="bold">&#x2717; 脆弱 — CSRFトークンなし</text>
    <text x="55" y="604" fill="#fca5a5" font-size="10" font-family="monospace">app.post('/api/change-password',</text>
    <text x="55" y="620" fill="#fca5a5" font-size="10" font-family="monospace">  async (c) =&gt; {</text>
    <text x="55" y="636" fill="#fca5a5" font-size="10" font-family="monospace">  // Cookieだけで認証 → 外部サイトから</text>
    <text x="55" y="652" fill="#fca5a5" font-size="10" font-family="monospace">  // のリクエストも受け入れてしまう</text>
    <text x="55" y="668" fill="#fca5a5" font-size="10" font-family="monospace">})</text>
  </g>

  <!-- 安全なコード -->
  <g>
    <rect x="470" y="560" width="410" height="120" rx="8" fill="#052e16" stroke="#34d399" stroke-width="1"/>
    <text x="485" y="582" fill="#34d399" font-size="12" font-weight="bold">&#x2713; 安全 — CSRFトークンで検証</text>
    <text x="485" y="604" fill="#6ee7b7" font-size="10" font-family="monospace">app.post('/api/change-password',</text>
    <text x="485" y="620" fill="#6ee7b7" font-size="10" font-family="monospace">  async (c) =&gt; {</text>
    <text x="485" y="636" fill="#6ee7b7" font-size="10" font-family="monospace">  const token = c.req.header('X-CSRF-Token')</text>
    <text x="485" y="652" fill="#6ee7b7" font-size="10" font-family="monospace">  if (token !== session.csrfToken)</text>
    <text x="485" y="668" fill="#6ee7b7" font-size="10" font-family="monospace">    return c.json({error:'Invalid'},403)</text>
  </g>
</svg>
